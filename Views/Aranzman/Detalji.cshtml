@model WebAranzmani.Models.AranzmanInfo
@{
    ViewBag.Title = "Detalji aranžmana";

    var smestaji = ViewBag.Smestaji as List<WebAranzmani.Models.SmestajInfo> ?? new List<WebAranzmani.Models.SmestajInfo>();
    var korisnik = Session["Korisnik"] as WebAranzmani.Models.KorisnikInfo;
    bool korisnikPrijavljen = korisnik != null && korisnik.Uloga == WebAranzmani.Models.Uloga.Turista;
    bool jeMenadzer = korisnik != null && korisnik.Uloga == WebAranzmani.Models.Uloga.Menadzer;
}

<style>
    :root {
        --c-deep: #2c003e; /* najtamnija ljubičasta */
        --c-mid: #4a148c; /* jaka ljubičasta */
        --c-sky: #6a1b9a; /* bordo-ljubičasta za fade */
        --glass: rgba(255,255,255,.08);
        --stroke: rgba(255,255,255,.18);
        --text: #f5f3fa; /* svetlo-lavanda tekst */
        --text-dim: #d1c4e9; /* prigušena lavanda */
    }

    body {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--c-deep), var(--c-mid) 50%, var(--c-sky) 120%);
        color: var(--text);
    }


    .card {
        background: var(--glass) !important;
        border: 1px solid var(--stroke) !important;
        border-radius: 18px !important;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,.25);
        color: var(--text);
    }

    .page-title {
        font-weight: 800;
        background: linear-gradient(90deg,#fff,#e1bee7 50%,#ffffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 20px rgba(0,0,0,.15);
    }

    .trip-hero {
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0,0,0,.35);
    }

    .trip-meta strong {
        color: #e1bee7;
    }

    .btn {
        border-radius: 10px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,.25);
    }

    .btn-success {
        background: linear-gradient(90deg,#6a1b9a,#8e24aa);
        color: #fff;
    }

    .btn-danger {
        background: linear-gradient(90deg,#b71c1c,#e53935);
        color: #fff;
    }

    .btn-secondary {
        background: linear-gradient(90deg,#6d4c41,#8d6e63);
        color: #fff;
    }

    .jedinice-table thead th {
        background: linear-gradient(90deg,#7b1fa2,#9c27b0);
        color: #fff;
        border: none;
    }

    .jedinice-table tbody tr:nth-child(odd) {
        background: rgba(255,255,255,.03);
    }

    .rating {
        color: #ffeb3b;
    }

    .comments-wrap {
        margin-top: 12px;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255,255,255,.04);
    }

    .comments-header {
        padding: 10px;
        font-weight: 700;
        background: linear-gradient(90deg,#9c27b0,#7b1fa2);
        color: #fff;
    }
</style>

<div class="container my-5">

    @if (TempData["OK"] != null)
    {<div class="alert alert-success">@TempData["OK"]</div>}
    @if (TempData["Greska"] != null)
    {<div class="alert alert-danger">@TempData["Greska"]</div>}

    <!-- Hero sekcija -->
    <div class="row mb-5">
        <div class="col-lg-7">
            <img src="~/Content/Images/@Model.Poster" class="img-fluid trip-hero" alt="@Model.Naziv" />
        </div>
        <div class="col-lg-5 d-flex flex-column justify-content-center">
            <h1 class="page-title mb-3">@Model.Naziv</h1>
            <p class="lead">@Model.Opis</p>
            <ul class="list-unstyled trip-meta">
                <li><strong>Početak:</strong> @Model.DatumPocetka.ToShortDateString()</li>
                <li><strong>Kraj:</strong> @Model.DatumZavrsetka.ToShortDateString()</li>
                <li><strong>Maks putnika:</strong> @Model.BrojPutnika</li>
                <li><strong>Prevoz:</strong> @Model.VrstaPrevoza</li>
                <li><strong>Lokacija:</strong> @Model.VrstaLokacije</li>
                <li><strong>Paket:</strong> @Model.Paket</li>
            </ul>
        </div>
    </div>

    <!-- Program -->
    <div class="card mb-4 p-3">
        <h4 class="fw-bold mb-2">📜 Program putovanja</h4>
        <p class="mb-0">@Model.Plan</p>
    </div>

    <!-- 🔍 Filter sekcija -->
    <div class="card mb-4 p-3">
        <h5 class="fw-bold mb-3">Filter i sortiranje</h5>
        <div class="row g-2">
            <div class="col-md-3">
                <input id="filterNaziv" type="text" class="form-control" placeholder="Naziv smeštaja" />
            </div>
            <div class="col-md-2">
                <select id="filterTip" class="form-select">
                    <option value="">-- Tip --</option>
                    <option value="hotel">Hotel</option>
                    <option value="motel">Motel</option>
                    <option value="vila">Vila</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filterBazen" class="form-select">
                    <option value="">-- Bazen --</option>
                    <option value="true">Da</option>
                    <option value="false">Ne</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filterSpa" class="form-select">
                    <option value="">-- Spa --</option>
                    <option value="true">Da</option>
                    <option value="false">Ne</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filterWifi" class="form-select">
                    <option value="">-- WiFi --</option>
                    <option value="true">Da</option>
                    <option value="false">Ne</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="filterInvaliditet" class="form-select">
                    <option value="">-- Prilagođeno --</option>
                    <option value="true">Da</option>
                    <option value="false">Ne</option>
                </select>
            </div>
            <div class="col-md-2">
                <input id="minGostiju" type="number" class="form-control" placeholder="Min gostiju" />
            </div>
            <div class="col-md-2">
                <input id="maxGostiju" type="number" class="form-control" placeholder="Max gostiju" />
            </div>
            <div class="col-md-2">
                <select id="filterLjubimci" class="form-select">
                    <option value="">-- Ljubimci --</option>
                    <option value="true">Da</option>
                    <option value="false">Ne</option>
                </select>
            </div>
            <div class="col-md-2">
                <input id="maxCena" type="number" class="form-control" placeholder="Max cena (€)" />
            </div>
            <div class="col-md-3">
                <select id="sortSmestaji" class="form-select">
                    <option value="">-- Sortiraj smeštaje --</option>
                    <option value="nazivAsc">Naziv (A-Z)</option>
                    <option value="nazivDesc">Naziv (Z-A)</option>
                    <option value="jediniceAsc">Broj jedinica (rast.)</option>
                    <option value="jediniceDesc">Broj jedinica (opad.)</option>
                    <option value="slobodneAsc">Slobodne (rast.)</option>
                    <option value="slobodneDesc">Slobodne (opad.)</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="sortJedinice" class="form-select">
                    <option value="">-- Sortiraj jedinice --</option>
                    <option value="gostAsc">Gostiju (rast.)</option>
                    <option value="gostDesc">Gostiju (opad.)</option>
                    <option value="cenaAsc">Cena (rast.)</option>
                    <option value="cenaDesc">Cena (opad.)</option>
                </select>
            </div>
        </div>
        <div class="mt-3 d-flex gap-2">
            <button id="applyFilters" class="btn btn-success btn-sm">Primeni</button>
            <button id="resetFilters" class="btn btn-secondary btn-sm">Resetuj</button>
        </div>
    </div>

    <!-- Smeštaji -->
    <h3 class="fw-bold mb-4 page-title">Smeštaji</h3>
    <div class="row" id="smestajiContainer">
        @if (smestaji.Any())
        {
            foreach (var sm in smestaji)
            {
                int slobodne = sm.SmestajneJedinice?.Count(j => j.Status == WebAranzmani.Models.StatusJedinice.Slobodna) ?? 0;
                <div class="col-md-12 mb-4 smestaj-card"
                     data-naziv="@sm.Naziv"
                     data-tip="@sm.Vrsta.ToString().ToLower()"
                     data-bazen="@sm.Bazen.ToString().ToLower()"
                     data-spa="@sm.SpaCentar.ToString().ToLower()"
                     data-wifi="@sm.Wifi.ToString().ToLower()"
                     data-invaliditet="@sm.Prilagodjen.ToString().ToLower()"
                     data-jedinice="@sm.SmestajneJedinice.Count"
                     data-slobodne="@slobodne">
                    <div class="card p-3">
                        <h5>@sm.Naziv (@sm.Vrsta)</h5>

                        @if (sm.Vrsta == WebAranzmani.Models.VrstaSmestaja.Hotel && sm.Zvezdice.HasValue)
                        {
                            var stars = Math.Max(0, Math.Min(5, sm.Zvezdice.Value));
                            <div class="rating">@Html.Raw(new string('★', stars))@Html.Raw(new string('☆', 5 - stars))</div>
                        }

                        <p class="text-muted">
                            <strong>Bazen:</strong> @(sm.Bazen ? "Da" : "Ne") |
                            <strong>Spa:</strong> @(sm.SpaCentar ? "Da" : "Ne") |
                            <strong>WiFi:</strong> @(sm.Wifi ? "Da" : "Ne") |
                            <strong>Prilagođeno:</strong> @(sm.Prilagodjen ? "Da" : "Ne")
                        </p>
                        <p class="text-muted"><strong>Ukupno jedinica:</strong> @sm.SmestajneJedinice.Count | <strong>Slobodnih:</strong> @slobodne</p>

                        @if (sm.SmestajneJedinice.Any())
                        {
                            <table class="table table-sm jedinice-table">
                                <thead>
                                    <tr><th>Gostiju</th><th>Ljubimci</th><th>Cena (EUR)</th><th>Status / Akcija</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var j in sm.SmestajneJedinice)
                                    {
                                        <tr class="jedinica-row"
                                            data-gostiju="@j.BrojGostiju"
                                            data-cena="@j.Cena"
                                            data-ljubimci="@j.Ljubimci.ToString().ToLower()">
                                            <td>@j.BrojGostiju</td>
                                            <td>@(j.Ljubimci ? "Da" : "Ne")</td>
                                            <td>@j.Cena</td>
                                            <td>
                                                @if (jeMenadzer)
                                                {
                                                    if (j.Status == WebAranzmani.Models.StatusJedinice.Slobodna)
                                                    {
                                                        <a class="btn btn-sm btn-success"
                                                           href="@Url.Action("RezervisiMenadzer","Rezervacija", new { aranzmanId = Model.Sifra, smestajId = sm.SmestajId, jedinicaId = j.JedinicaId })">
                                                            Rezerviši
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <a class="btn btn-sm btn-danger"
                                                           href="@Url.Action("OtkaziMenadzer","Rezervacija", new { jedinicaId = j.JedinicaId })">
                                                            Otkaži
                                                        </a>
                                                    }
                                                }
                                                else if (korisnikPrijavljen)
                                                {
                                                    var rezRepo = new WebAranzmani.Repositories.RezervazcijeRepozitorijum();
                                                    var mojaRez = rezRepo.PronadjiSve().FirstOrDefault(r =>
                                                        r.Turista == korisnik.KorisnickoIme &&
                                                        r.AranzmanId == Model.Sifra &&
                                                        r.SmestajnaJedinicaId == j.JedinicaId &&
                                                        r.Status == WebAranzmani.Models.StatusRezervacije.Aktivna);

                                                    if (mojaRez != null)
                                                    {
                                                        <a class="btn btn-sm btn-danger"
                                                           href="@Url.Action("Otkazi","Rezervacija", new { id = mojaRez.RezervacijaId })">
                                                            Otkaži
                                                        </a>
                                                    }
                                                    else if (j.Status == WebAranzmani.Models.StatusJedinice.Slobodna)
                                                    {
                                                        <a class="btn btn-sm btn-success"
                                                           href="@Url.Action("Kreiraj","Rezervacija", new { aranzmanId = Model.Sifra, smestajId = sm.SmestajId, jedinicaId = j.JedinicaId })">
                                                            Rezerviši
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Zauzeta</span>
                                                    }
                                                }
                                                else
                                                {
                                                    if (j.Status == WebAranzmani.Models.StatusJedinice.Slobodna)
                                                    {
                                                        <span class="badge bg-success">Slobodna</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Zauzeta</span>
                                                    }
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        { <p class="fst-italic">Nema smeštajnih jedinica.</p>}

                        <div class="comments-wrap mt-3">
                            <div class="comments-header">Komentari</div>
                            <div class="p-3">@Html.Action("PublicComments", "Komentar", new { smestajNaziv = sm.Naziv })</div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        { <p class="fst-italic">Nema smeštaja za ovaj aranžman.</p>}
    </div>
</div>

<script src="~/Scripts/detaljiHome.js"></script>
